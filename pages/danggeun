import streamlit as st
from datetime import datetime

# 1. í˜ì´ì§€ ì´ˆê¸° ì„¤ì •
st.set_page_config(page_title="ì¤‘ê³ ì¥í„°", layout="centered")

# 2. ë°ì´í„° ì €ì¥ì†Œ ì´ˆê¸°í™”
if "market_items" not in st.session_state:
    st.session_state["market_items"] = []

# 3. ì‚¬ì´ë“œë°”: íŒë§¤ ë“±ë¡
st.sidebar.header("ğŸ¥• ë¬¼ê±´ íŒ”ê¸°")
with st.sidebar.form("sale_form", clear_on_submit=True):
    user_name = st.text_input("ë‹‰ë„¤ì„")
    item_title = st.text_input("ìƒí’ˆëª…")
    price = st.text_input("ê°€ê²©")
    file = st.file_uploader("ì‚¬ì§„", type=['jpg', 'png', 'jpeg'])
    submit = st.form_submit_button("ë“±ë¡í•˜ê¸°")

    if submit:
        if user_name and item_title and file:
            # ì´ë¯¸ì§€ ì½ê¸°
            img_data = file.read()
            # ë°ì´í„° ì¶”ê°€
            new_item = {
                "user": user_name,
                "title": item_title,
                "price": price,
                "image": img_data,
                "chats": [],
                "time": datetime.now().strftime("%H:%M")
            }
            st.session_state["market_items"].insert(0, new_item)
            st.success("ë“±ë¡ ì™„ë£Œ!")
        else:
            st.error("ë‚´ìš©ì„ ëª¨ë‘ ì±„ì›Œì£¼ì„¸ìš”.")

# 4. ë©”ì¸ í™”ë©´: ìƒí’ˆ ëª©ë¡
st.title("ğŸ¥• ë‹¹ê·¼ ì¤‘ê³ ê±°ë˜")

if not st.session_state["market_items"]:
    st.info("í˜„ì¬ ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.")
else:
    for i, item in enumerate(st.session_state["market_items"]):
        with st.container():
            col1, col2 = st.columns([1, 2])
            with col1:
                st.image(item["image"], use_container_width=True)
            with col2:
                st.subheader(item["title"])
                st.write(f"**ê°€ê²©:** {item['price']}ì›")
                st.caption(f"íŒë§¤ì: {item['user']} | {item['time']}")
                
                # ëŒ€í™” ê¸°ëŠ¥
                with st.expander(f"ğŸ’¬ ëŒ€í™”í•˜ê¸° ({len(item['chats'])}ê°œ)"):
                    for c in item["chats"]:
                        st.write(f"**{c['u']}**: {c['m']}")
                    
                    # ì±„íŒ… ì…ë ¥
                    c_u = st.text_input("ë‚´ì´ë¦„", key=f"u{i}")
                    c_m = st.text_input("ë©”ì‹œì§€", key=f"m{i}")
                    if st.button("ì „ì†¡", key=f"b{i}"):
                        if c_u and c_m:
                            item["chats"].append({"u": c_u, "m": c_m})
                            st.rerun()
            st.divider()
