import streamlit as st
from datetime import datetime

# 1. í˜ì´ì§€ ì„¤ì •
st.set_page_config(page_title="ìš°ë¦¬ë™ë„¤ ì¤‘ê³ ì¥í„°", page_icon="ğŸ¥•")

# 2. ë°ì´í„° ì €ì¥ì†Œ ì´ˆê¸°í™” (ì•±ì´ ì‹¤í–‰ë˜ëŠ” ë™ì•ˆ ë©”ëª¨ë¦¬ì— ìœ ì§€ë¨)
if 'items' not in st.session_state:
    st.session_state.items = []

# 3. ì‚¬ì´ë“œë°” - ë¬¼ê±´ ì˜¬ë¦¬ê¸°
with st.sidebar:
    st.header("ğŸ¥• ë‚´ ë¬¼ê±´ íŒ”ê¸°")
    with st.form("upload_form", clear_on_submit=True):
        seller_name = st.text_input("íŒë§¤ì ë‹‰ë„¤ì„")
        item_name = st.text_input("ë¬¼ê±´ ì´ë¦„")
        item_price = st.text_input("ê°€ê²© (ì›)")
        item_img = st.file_uploader("ì‚¬ì§„ ì—…ë¡œë“œ", type=['jpg', 'png', 'jpeg'])
        submitted = st.form_submit_button("ë“±ë¡í•˜ê¸°")
        
        if submitted and seller_name and item_name and item_img:
            new_item = {
                "id": len(st.session_state.items),
                "seller": seller_name,
                "name": item_name,
                "price": item_price,
                "image": item_img.read(), # ì‚¬ì§„ì„ ë°”ì´ë„ˆë¦¬ë¡œ ì €ì¥
                "chats": [],
                "date": datetime.now().strftime("%Y-%m-%d %H:%M")
            }
            st.session_state.items.insert(0, new_item) # ìµœì‹ ê¸€ì´ ìœ„ë¡œ ì˜¤ê²Œ ì €ì¥
            st.success("ê²Œì‹œê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!")

# 4. ë©”ì¸ í™”ë©´ - ê²Œì‹œê¸€ ëª©ë¡ ë° ì±„íŒ…
st.title("ğŸ¥• ë‹¹ê·¼ ìŠ¤íƒ€ì¼ ì¤‘ê³ ê±°ë˜")
st.write("ì‹¤ì‹œê°„ìœ¼ë¡œ ì˜¬ë¼ì˜¨ ë¬¼ê±´ì„ í™•ì¸í•˜ê³  ëŒ€í™”ë¥¼ ë‚˜ëˆ ë³´ì„¸ìš”.")

if not st.session_state.items:
    st.info("ì•„ì§ ë“±ë¡ëœ ë¬¼ê±´ì´ ì—†ìŠµë‹ˆë‹¤. ì™¼ìª½ ì‚¬ì´ë“œë°”ì—ì„œ ì²« ë¬¼ê±´ì„ ë“±ë¡í•´ë³´ì„¸ìš”!")

for idx, item in enumerate(st.session_state.items):
    with st.container():
        col1, col2 = st.columns([1, 2])
        
        with col1:
            st.image(item["image"], use_container_width=True)
            
        with col2:
            st.subheader(item["name"])
            st.write(f"**ê°€ê²©:** {item['price']}ì›")
            st.caption(f"íŒë§¤ì: {item['seller']} | ë“±ë¡ì‹œê°„: {item['date']}")
            
            # ì±„íŒ… ê¸°ëŠ¥ (ëŒ“ê¸€ ë°©ì‹)
            with st.expander(f"ğŸ’¬ ëŒ€í™”í•˜ê¸° ({len(item['chats'])}ê°œ)"):
                # ê¸°ì¡´ ë©”ì‹œì§€ ì¶œë ¥
                for chat in item["chats"]:
                    st.write(f"**{chat['user']}:** {chat['msg']}")
                
                # ë©”ì‹œì§€ ì…ë ¥
                chat_user = st.text_input("ë‚´ ë‹‰ë„¤ì„", key=f"user_{idx}")
                chat_msg = st.text_input("ë©”ì‹œì§€ ì…ë ¥", key=f"msg_{idx}")
                if st.button("ì „ì†¡", key=f"btn_{idx}"):
                    if chat_user and chat_msg:
