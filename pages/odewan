import streamlit as st
from datetime import datetime, date

# 1. ì•± ì„¤ì • (ì‹œê°ë””ìì¸ ì „ê³µì ëŠë‚Œì˜ ê¹”ë”í•œ êµ¬ì„±)
st.set_page_config(page_title="ì˜¤ë””ì™„ | ì˜¤ëŠ˜ ë””ìì¸ ì™„ë£Œ", page_icon="ğŸ¨", layout="wide")

# 2. ë°ì´í„° ì´ˆê¸°í™”
if 'designs' not in st.session_state:
    st.session_state.designs = []
if 'user_streak' not in st.session_state:
    st.session_state.user_streak = 0

# 3. ë°°ì§€ ì‹œìŠ¤í…œ ë¡œì§
def get_badge(streak):
    if streak >= 30: return "ğŸ’ ë‹¤ì´ì•„ ë””ìì´ë„ˆ", "âœ¨ ë‹¹ì‹ ì€ ì´ì œ ë””ìì¸ ë§ˆìŠ¤í„°!"
    if streak >= 14: return "ğŸ¥‡ ê³¨ë“œ ë””ìì´ë„ˆ", "ğŸ”¥ 2ì£¼ ì—°ì†ì´ë¼ë‹ˆ ëŒ€ë‹¨í•´ìš”!"
    if streak >= 7: return "ğŸ¥ˆ ì‹¤ë²„ ë””ìì´ë„ˆ", "ğŸŒ¿ ê¾¸ì¤€í•¨ì˜ ì—´ë§¤ê°€ ë§ºíˆê³  ìˆì–´ìš”."
    if streak >= 1: return "ğŸ¥‰ ë¸Œë¡ ì¦ˆ ë””ìì´ë„ˆ", "ğŸŒ± ì‹œì‘ì´ ë°˜! ì˜¤ëŠ˜ë„ í™”ì´íŒ…!"
    return "ğŸ¥š ìƒˆë‚´ê¸° ë””ìì´ë„ˆ", "ğŸ¨ ì²« ë””ìì¸ ë¯¸ì…˜ì„ ì™„ë£Œí•´ë³´ì„¸ìš”!"

# 4. ì‚¬ì´ë“œë°” (ë‚´ ì •ë³´ ë° ë°°ì§€)
st.sidebar.title("ğŸ¨ ì˜¤ë””ì™„")
st.sidebar.caption("ì˜¤ëŠ˜ ë””ìì¸ ì™„ë£Œí•˜ì…¨ë‚˜ìš”?")

badge_name, badge_msg = get_badge(st.session_state.user_streak)
st.sidebar.info(f"**í˜„ì¬ ë“±ê¸‰: {badge_name}**\n\n{badge_msg}")
st.sidebar.metric("ì—°ì† ê¸°ë¡", f"{st.session_state.user_streak}ì¼ì°¨")

menu = ["ğŸ  í”¼ë“œ ë³´ê¸°", "âœ… ë¯¸ì…˜ ì¸ì¦í•˜ê¸°", "ğŸ“… ë‚˜ì˜ ê¸°ë¡"]
page = st.sidebar.radio("ë©”ë‰´", menu)

# --- [í˜ì´ì§€ 1: í”¼ë“œ ë³´ê¸°] ---
if page == "ğŸ  í”¼ë“œ ë³´ê¸°":
    st.title("ğŸ–¼ï¸ ìš°ë¦¬ë“¤ì˜ ë””ìì¸ í”¼ë“œ")
    st.write("ë‹¤ë¥¸ ì¹œêµ¬ë“¤ì€ ì˜¤ëŠ˜ ì–´ë–¤ ë¯¸ì…˜ì„ ìˆ˜í–‰í–ˆì„ê¹Œìš”?")
    
    if not st.session_state.designs:
        st.info("ì•„ì§ ì˜¬ë¼ì˜¨ ì¸ì¦ìƒ·ì´ ì—†ì–´ìš”. ì²« ë²ˆì§¸ ì¸ì¦ì˜ ì£¼ì¸ê³µì´ ë˜ì–´ë³´ì„¸ìš”!")
    else:
        # 3ì—´ ê·¸ë¦¬ë“œë¡œ ë””ìì¸ ì‘í’ˆ ì „ì‹œ
        cols = st.columns(3)
        for idx, item in enumerate(reversed(st.session_state.designs)):
            with cols[idx % 3]:
                with st.container(border=True):
                    if item['img']:
                        st.image(item['img'], use_container_width=True)
                    st.subheader(item['mission'])
                    st.caption(f"ğŸ“… {item['date']} | ğŸ‘¤ {item['user']}")
                    st.write(f"ğŸ’¬ {item['memo']}")

# --- [í˜ì´ì§€ 2: ë¯¸ì…˜ ì¸ì¦í•˜ê¸°] ---
elif page == "âœ… ë¯¸ì…˜ ì¸ì¦í•˜ê¸°":
    st.title("ğŸš€ ì˜¤ëŠ˜ì˜ ë¯¸ì…˜ ì¸ì¦")
    
    # ì˜¤ëŠ˜ì˜ ì¶”ì²œ ë¯¸ì…˜ (ëœë¤ ëŠë‚Œìœ¼ë¡œ êµ¬ì„± ê°€ëŠ¥)
    missions = ["ë¡œê³  íƒ€ì´í¬ê·¸ë˜í”¼ ê·¸ë¦¬ê¸°", "ë³´ìƒ‰ ëŒ€ë¹„ ë°°ìƒ‰ ì—°ìŠµ", "í¬ìŠ¤í„° ë ˆì´ì•„ì›ƒ ì¡ê¸°", "ì¢‹ì•„í•˜ëŠ” í°íŠ¸ ì¡°í•©í•˜ê¸°"]
    today_mission = missions[date.today().day % len(missions)]
    
    st.warning(f"ğŸ’¡ ì˜¤ëŠ˜ì˜ ì¶”ì²œ ë¯¸ì…˜: **{today_mission}**")
    
    with st.form("upload_form", clear_on_submit=True):
        u_name = st.text_input("ì´ë¦„(ë‹‰ë„¤ì„)", value="ë™ë•ë””ìì´ë„ˆ")
        mission_choice = st.selectbox("ìˆ˜í–‰í•œ ë¯¸ì…˜", [today_mission] + missions)
        img_file = st.file_uploader("ë””ìì¸ ê²°ê³¼ë¬¼ ì—…ë¡œë“œ", type=['jpg', 'png', 'jpeg'])
        memo = st.text_area("ì‘ì—… ë…¸íŠ¸ (ê°„ë‹¨í•œ ì„¤ëª…)")
        
        submitted = st.form_submit_button("ì¸ì¦ ì™„ë£Œ!")
        
        if submitted:
            if img_file:
                # ë°ì´í„° ì €ì¥
                new_entry = {
                    "user": u_name,
                    "mission": mission_choice,
                    "img": img_file,
                    "memo": memo,
                    "date": str(date.today())
                }
                st.session_state.designs.append(new_entry)
                st.session_state.user_streak += 1 # ìŠ¤íŠ¸ë¦­ ì¦ê°€
                st.success("ì˜¤ëŠ˜ì˜ ë””ìì¸ ì™„ë£Œ! ë°°ì§€ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆëŠ”ì§€ í™•ì¸í•´ë³´ì„¸ìš”.")
                st.balloons()
            else:
                st.error("ë””ìì¸ ê²°ê³¼ë¬¼ ì‚¬ì§„ì„ ê¼­ ì˜¬ë ¤ì£¼ì„¸ìš”!")

# --- [í˜ì´ì§€ 3: ë‚˜ì˜ ê¸°ë¡ (ë‹¬ë ¥ í˜•íƒœ)] ---
elif page == "ğŸ“… ë‚˜ì˜ ê¸°ë¡":
    st.title("ğŸ—“ï¸ ë‚˜ì˜ ë””ìì¸ ìº˜ë¦°ë”")
    
    # ê°„ì´ ë‹¬ë ¥ êµ¬í˜„
    st.write("ì´ë²ˆ ë‹¬ ë‚˜ì˜ í™œë™ ê¸°ë¡ì…ë‹ˆë‹¤.")
    
    # ì‹¤ì œ ë‹¬ë ¥ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì—†ì´ ì‹œê°í™”
    today = date.today()
    st.subheader(f"{today.year}ë…„ {today.month}ì›”")
    
    # ì¸ì¦ëœ ë‚ ì§œ ë¦¬ìŠ¤íŠ¸ ì¶”ì¶œ
    completed_days = [d['date'] for d in st.session_state.designs]
    
    # 7ì¼ì”© ëŠì–´ì„œ í‘œì‹œ
    for week in range(0, 31, 7):
        cols = st.columns(7)
        for i in range(7):
            day = week + i + 1
            if day <= 31:
                with cols[i]:
                    # ì˜¤ëŠ˜ ë‚ ì§œì™€ ì¸ì¦ëœ ë‚ ì§œ í‘œì‹œ
                    date_str = f"{today.year}-{today.month:02d}-{day:02d}"
                    if date_str in completed_days:
                        st.success(f"**{day}**\nğŸ¨")
                    elif day == today.day:
                        st.info(f"{day}\n(ì˜¤ëŠ˜)")
                    else:
                        st.write(day)

# ë°ì´í„° ì´ˆê¸°í™” (í…ŒìŠ¤íŠ¸ìš©)
if st.sidebar.button("ë°ì´í„° ì´ˆê¸°í™”"):
    st.session_state.designs = []
    st.session_state.user_streak = 0
    st.rerun()
